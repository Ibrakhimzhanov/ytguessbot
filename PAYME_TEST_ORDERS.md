# üß™ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è Payme

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

1. –°–æ–∑–¥–∞—Ç—å 2 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Ö –¥–∞–Ω–Ω—ã–µ –ò–≥–æ—Ä—é –∏–∑ Payme –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ SQL (–±—ã—Å—Ç—Ä–æ)

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@91.184.247.219

# 2. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
cd /srv/postgres/ytguessbot
psql "$DATABASE_URL"
```

–í—ã–ø–æ–ª–Ω–∏ SQL –∫–æ–º–∞–Ω–¥—ã:

```sql
-- –ó–∞–∫–∞–∑ 1
INSERT INTO payments (
  id, 
  "userId", 
  "orderNumber", 
  amount, 
  currency, 
  status, 
  "createdAt"
)
VALUES (
  gen_random_uuid(),
  (SELECT id FROM users LIMIT 1),
  2001,
  1100000,
  'UZS',
  'PENDING',
  NOW()
);

-- –ó–∞–∫–∞–∑ 2
INSERT INTO payments (
  id, 
  "userId", 
  "orderNumber", 
  amount, 
  currency, 
  status, 
  "createdAt"
)
VALUES (
  gen_random_uuid(),
  (SELECT id FROM users LIMIT 1),
  2002,
  1100000,
  'UZS',
  'PENDING',
  NOW()
);

-- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å
SELECT "orderNumber", amount, currency, status, "createdAt" 
FROM payments 
WHERE "orderNumber" IN (2001, 2002);
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
```
 orderNumber | amount  | currency | status  |         createdAt          
-------------+---------+----------+---------+---------------------------
        2001 | 1100000 | UZS      | PENDING | 2025-01-10 15:30:45+05
        2002 | 1100000 | UZS      | PENDING | 2025-01-10 15:30:45+05
```

**–ì–æ—Ç–æ–≤–æ!** –í—ã–π–¥–∏ –∏–∑ psql: `\q`

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
# 2. –û—Ç–ø—Ä–∞–≤—å /start
# 3. –ù–∞–∂–º–∏ "üìö –ö—É–ø–∏—Ç—å –∫—É—Ä—Å"
# 4. –ü–æ–¥–µ–ª–∏—Å—å –Ω–æ–º–µ—Ä–æ–º
# 5. –ù–∞–∂–º–∏ "üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —á–µ—Ä–µ–∑ Payme"
# 6. –ó–∞–ø–æ–º–Ω–∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
# 7. –ü–æ–≤—Ç–æ—Ä–∏ –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–∫–∞–∑–∞
```

---

## üìß –ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ò–≥–æ—Ä—é:

### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ SQL:

```
–ü—Ä–∏–≤–µ—Ç –ò–≥–æ—Ä—å!

–¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã —Å–æ–∑–¥–∞–Ω—ã:

–ó–∞–∫–∞–∑ 1:
order_id: 2001
amount: 1100000 (–≤ —Ç–∏–π–∏–Ω–∞—Ö)

–ó–∞–∫–∞–∑ 2:
order_id: 2002
amount: 1100000 (–≤ —Ç–∏–π–∏–Ω–∞—Ö)

Endpoint: https://ytacademy.uz/api/payme/billing
Account –ø–∞—Ä–∞–º–µ—Ç—Ä: order_id (integer)

–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª—é—á –ø—Ä–æ–ø–∏—Å–∞–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
–ì–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!
```

---

### –ï—Å–ª–∏ —Å–æ–∑–¥–∞–≤–∞–ª —á–µ—Ä–µ–∑ –±–æ—Ç–∞:

–£–∑–Ω–∞–π –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–æ–≤:

```bash
psql "$DATABASE_URL"
```

```sql
SELECT "orderNumber", amount 
FROM payments 
ORDER BY "createdAt" DESC 
LIMIT 2;
```

–ü–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤—å –¥–∞–Ω–Ω—ã–µ –ò–≥–æ—Ä—é (—Å–º. –≤—ã—à–µ).

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ò–≥–æ—Ä—é:

### 1. –£–±–µ–¥–∏—Å—å —á—Ç–æ credentials –¥–æ–±–∞–≤–ª–µ–Ω—ã:

```bash
cat .env | grep PAYME_X_AUTH
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
PAYME_X_AUTH=68dfaed6eb0789cb092fb03e:GjdJQHqcqjYFmZDpjhbM#rXdYAPq7XnB0GyM
```

### 2. –£–±–µ–¥–∏—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω:

```bash
pm2 status ytguessbot
```

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å `online`.

### 3. –ü—Ä–æ–≤–µ—Ä—å endpoint:

```bash
curl -i https://ytacademy.uz/api/payme/billing
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å `401` (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç Payme).

### 4. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∑–∞–∫–∞–∑—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç:

```bash
psql "$DATABASE_URL" -c "SELECT \"orderNumber\", amount, status FROM payments WHERE \"orderNumber\" IN (2001, 2002);"
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –æ–±–∞ –∑–∞–∫–∞–∑–∞.

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] Credentials –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env`
- [ ] –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Endpoint –¥–æ—Å—Ç—É–ø–µ–Ω (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401)
- [ ] –°–æ–∑–¥–∞–Ω–æ 2 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞ (2001, 2002)
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã order_id –∏ amount
- [ ] –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –ò–≥–æ—Ä—é

---

## üîÑ –ß—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ:

1. **–ò–≥–æ—Ä—å –ø–æ–ª—É—á–∏—Ç –¥–∞–Ω–Ω—ã–µ**
2. **Payme –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å—ã:**
   - `CheckPerformTransaction` –¥–ª—è –∑–∞–∫–∞–∑–∞ 2001
   - `CheckPerformTransaction` –¥–ª—è –∑–∞–∫–∞–∑–∞ 2002
3. **–í–∞—à —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç:** `{"result": {"allow": true}}`
4. **–ò–≥–æ—Ä—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ—Ç:**
   - –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
   - –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
   - –û—Ç–º–µ–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ

---

## üìä –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```bash
pm2 logs ytguessbot --lines 50
```

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è:
```
üîµ Payme Billing Request received
üìã Payme Request: {
  "method": "CheckPerformTransaction",
  "params": {
    "account": { "order_id": "2001" },
    "amount": 1100000
  }
}
üü¢ Payme Response: {
  "result": { "allow": true }
}
```

---

## üö® –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫:

### –û—à–∏–±–∫–∞: "Order not found"
```bash
# –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∑–∞–∫–∞–∑—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
psql "$DATABASE_URL" -c "SELECT * FROM payments WHERE \"orderNumber\" IN (2001, 2002);"
```

### –û—à–∏–±–∫–∞: "Invalid authorization"
```bash
# –ü—Ä–æ–≤–µ—Ä—å PAYME_X_AUTH
cat .env | grep PAYME_X_AUTH

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–µ–∑ –∫–∞–≤—ã—á–µ–∫:
PAYME_X_AUTH=68dfaed6eb0789cb092fb03e:GjdJQHqcqjYFmZDpjhbM#rXdYAPq7XnB0GyM
```

### –û—à–∏–±–∫–∞: "Cannot connect to database"
```bash
# –ü—Ä–æ–≤–µ—Ä—å DATABASE_URL
cat .env | grep DATABASE_URL

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
psql "$DATABASE_URL" -c "SELECT 1;"
```

---

**–°–æ–∑–¥–∞–≤–∞–π –∑–∞–∫–∞–∑—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π –¥–∞–Ω–Ω—ã–µ –ò–≥–æ—Ä—é!** üöÄ
