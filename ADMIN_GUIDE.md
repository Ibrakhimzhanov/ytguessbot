# 🔧 Руководство администратора

## 📋 Содержание
- [Роли и права доступа](#роли-и-права-доступа)
- [Настройка админов](#настройка-админов)
- [Админ-панель](#админ-панель)
- [Функции админа](#функции-админа)
- [Экспорт данных](#экспорт-данных)
- [Управление розыгрышем](#управление-розыгрышем)

---

## 🔐 Роли и права доступа

### Роли

**👑 Owner (Владелец)**
- Полный доступ ко всем функциям
- Управление розыгрышами
- Экспорт данных
- Просмотр статистики
- Выбор победителя

**🔧 Admin (Администратор)**
- Доступ к админ-панели
- Экспорт данных
- Просмотр статистики
- Управление розыгрышами
- Выбор победителя

---

## ⚙️ Настройка админов

### 1. Получите свой Telegram ID

Отправьте любое сообщение боту **@userinfobot** в Telegram.  
Он вернет ваш ID (например: `123456789`)

### 2. Добавьте ID в `.env`

```env
# Owner - полный доступ (через запятую)
OWNER_IDS=123456789,987654321

# Admin - доступ к админ-панели (через запятую)
ADMIN_IDS=111111111,222222222,333333333
```

⚠️ **Важно**: Используйте только **числовые ID**, не username!

### 3. Перезапустите бота

```bash
# Остановите бота (Ctrl+C)
# Запустите заново
npm run bot
```

---

## 🎛️ Админ-панель

### Вход в админ-панель

1. Отправьте `/start` боту
2. Если вы админ, вы увидите кнопку **"🔧 Админ-панель"**
3. Нажмите на неё

### Доступные кнопки

```
┌────────────────────────────────────┐
│  🔔 Управление розыгрышем          │
│  🗂 Экспорт XLSX                   │
├────────────────────────────────────┤
│  🎁 Выбрать победителя             │
│  🏆 История розыгрышей             │
├────────────────────────────────────┤
│  🧾 Чек по userId                  │
│  📊 Статистика                     │
├────────────────────────────────────┤
│  👤 Вернуться в обычный режим      │
└────────────────────────────────────┘
```

### Переключение режимов

- **Админ → Обычный**: Нажмите "👤 Обычный режим"
- **Обычный → Админ**: Нажмите "🔧 Админ-панель"

---

## 📊 Функции админа

### 1. 📊 Статистика

**Команда:** `/admin_stats` или кнопка "📊 Статистика"

**Показывает:**
- Общее количество пользователей
- Количество оплативших (%)
- Количество не оплативших
- Статистику платежей (всего, оплачено, ожидают)
- Общий доход в сумах

**Пример вывода:**
```
📊 Статистика бота

👥 Пользователи:
• Всего: 52
• Оплативших: 10 (19%)
• Не оплативших: 42

💳 Платежи:
• Всего: 16
• Оплачено: 10
• В ожидании: 6

💰 Доход:
• Общий: 100,000 сум
```

---

## 📥 Экспорт данных

### 🗂 Экспорт XLSX

**Кнопка:** "🗂 Экспорт XLSX"

**Что делает:**
- Генерирует Excel файл со всеми пользователями
- Маскирует телефоны для безопасности
- Отправляет файл документом

**Формат файла:**

| User ID | Имя | Телефон (маска) | Username | Дата оплаты | Статус |
|---------|-----|-----------------|----------|-------------|---------|
| a1b2... | Алишер Алиев | +9989X *** ** 67 | @alisher_aliev123 | 01.01.2025, 12:00 | ✅ Оплачено |
| c3d4... | Камила Азимова | +9989X *** ** 45 | @kamila_azimova456 | - | ⏳ Не оплачено |

### 📱 Маскирование телефонов

**Формат:** `+998XX *** ** NN`

- `XX` - код оператора (94, 91, 97, 50)
- `***` - скрытые цифры
- `**` - скрытые цифры  
- `NN` - последние 2 цифры

**Примеры:**
- `+99894 123 45 67` → `+9989X *** ** 67`
- `+99891 234 56 78` → `+9989X *** ** 78`

---

## 🎰 Управление розыгрышем

### 🔔 Включить/Остановить розыгрыш

**Кнопка:** "🔔 Управление розыгрышем"

**Статусы:**
- 🔔 **Активен** - пользователи участвуют после оплаты
- ⏹ **Остановлен** - новые участники не добавляются

**Как использовать:**

1. Нажмите "🔔 Управление розыгрышем"
2. Увидите текущий статус
3. Нажмите кнопку для переключения:
   - "🔔 Включить розыгрыш" - активировать
   - "⏹ Остановить розыгрыш" - деактивировать

⚠️ **Защита от двойного клика:** Система блокирует повторные нажатия во время обработки.

---

## 🎁 Выбор победителя

### Как выбрать победителя

**Кнопка:** "🎁 Выбрать победителя"

**Процесс:**

1. Нажмите "🎁 Выбрать победителя"
2. Система проверит наличие участников (оплативших пользователей)
3. Запустится анимация (8 шагов по 250ms)
4. Будет выбран случайный победитель
5. Результат сохранится в БД
6. Победитель получит уведомление в Telegram

**Анимация:**
```
🎰 Выбираю победителя...

👤 Алишер Каримов
📱 +9989X *** ** 45
🆔 @alisher_karimov

... (8 раз меняется)

🎉 ПОБЕДИТЕЛЬ ВЫБРАН!

👤 Имя: Камила Азимова
📱 Телефон: +9989X *** ** 67
🆔 Username: @kamila_azimova
🎁 Приз: Главный приз

Поздравляем! 🎊
```

**Условия:**
- Должен быть хотя бы 1 оплативший пользователь
- Выбор равновероятный среди всех оплативших
- Защита от двойного клика во время выбора

---

## 🏆 История розыгрышей

**Кнопка:** "🏆 История розыгрышей"

**Показывает:**
- Последние 10 розыгрышей
- Дата и время каждого розыгрыша
- Данные победителя (с маскированным телефоном)
- Приз

**Пример:**
```
🏆 История розыгрышей (последние 10)

1. 01.01.2025, 15:30:45
👤 Алишер Каримов
📱 +9989X *** ** 45
🎁 Главный приз

2. 28.12.2024, 18:20:10
👤 Камила Азимова
📱 +9989X *** ** 67
🎁 Главный приз
```

---

## 🧾 Чек по userId

**Кнопка:** "🧾 Чек по userId"

**Как использовать:**

1. Нажмите "🧾 Чек по userId"
2. Бот попросит отправить User ID
3. Отправьте UUID пользователя (из XLSX экспорта)
4. Получите информацию о пользователе

**Формат User ID:**
```
a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

---

## 🚨 Важные замечания

### Безопасность

1. **Не делитесь** списком OWNER_IDS и ADMIN_IDS
2. **Не публикуйте** .env файл
3. **Маскируйте телефоны** при экспорте данных
4. **Не сохраняйте** XLSX файлы в публичных местах

### Лучшие практики

1. **Регулярно экспортируйте** данные для бэкапа
2. **Проверяйте статистику** перед розыгрышами
3. **Останавливайте розыгрыш** перед выбором победителя
4. **Сохраняйте историю** розыгрышей

### Решение проблем

**Бот не показывает админ-панель:**
- Проверьте `.env` файл
- Убедитесь что указан числовой ID, не username
- Перезапустите бота

**Ошибка при экспорте XLSX:**
- Проверьте подключение к БД
- Убедитесь что exceljs установлен: `npm install`

**Не могу выбрать победителя:**
- Убедитесь что есть оплатившие пользователи
- Проверьте что розыгрыш не заблокирован (подождите 2-3 секунды)

---

## 📞 Поддержка

Если возникли вопросы или проблемы:
1. Проверьте логи бота в консоли
2. Посмотрите `TESTING.md` для инструкций по тестированию
3. Проверьте `MOCK_PAYMENT_SUMMARY.md` для информации о mock оплате

---

**Версия:** 1.0.0  
**Дата:** 2025-01-10
